<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Open Platform</title>
    <link rel="icon" type="image/png" href="images/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="images/favicon-16x16.png" sizes="16x16" />
    <link href='css/typography.css' media='screen' rel='stylesheet' type='text/css'/>
    <!--link href='css/reset.css' media='screen' rel='stylesheet' type='text/css'/-->
    <link href='css/screen.css' media='screen' rel='stylesheet' type='text/css'/>
    <!--link href='css/reset.css' media='print' rel='stylesheet' type='text/css'/-->
    <link href='css/print.css' media='print' rel='stylesheet' type='text/css'/>

    <script src='lib/object-assign-pollyfill.js' type='text/javascript'></script>
    <script src='lib/jquery-1.8.0.min.js' type='text/javascript'></script>
    <script src='lib/jquery.slideto.min.js' type='text/javascript'></script>
    <script src='lib/jquery.wiggle.min.js' type='text/javascript'></script>
    <script src='lib/jquery.ba-bbq.min.js' type='text/javascript'></script>
    <script src='lib/handlebars-2.0.0.js' type='text/javascript'></script>
    <script src='lib/js-yaml.min.js' type='text/javascript'></script>
    <script src='lib/lodash.min.js' type='text/javascript'></script>
    <script src='lib/backbone-min.js' type='text/javascript'></script>
    <script src='swagger-ui.js' type='text/javascript'></script>
    <script src='lib/highlight.9.1.0.pack.js' type='text/javascript'></script>
    <script src='lib/highlight.9.1.0.pack_extended.js' type='text/javascript'></script>
    <script src='lib/jsoneditor.min.js' type='text/javascript'></script>
    <script src='lib/marked.js' type='text/javascript'></script>
    <script src='lib/swagger-oauth.js' type='text/javascript'></script>

    <!-- Some basic translations -->
    <!-- <script src='lang/translator.js' type='text/javascript'></script> -->
    <!-- <script src='lang/ru.js' type='text/javascript'></script> -->
    <!-- <script src='lang/en.js' type='text/javascript'></script> -->

    <script type="text/javascript">
$(function () {
  var url = window.location.search.match(/url=([^&]+)/);
  if (url && url.length > 1) {
    url = decodeURIComponent(url[1]);
  } else {
    url = "swagger.json";
  }

  hljs.configure({
    highlightSizeThreshold: 5000
  });

  // Pre load translate...
  if(window.SwaggerTranslator) {
    window.SwaggerTranslator.translate();
  }
  window.swaggerUi = new SwaggerUi({
    url: url,
    dom_id: "swagger-ui-container",
    supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch'],
    onComplete: function(swaggerApi, swaggerUi){
      if(typeof initOAuth == "function") {
        initOAuth({
          clientId: "your-client-id",
          clientSecret: "your-client-secret-if-required",
          realm: "your-realms",
          appName: "your-app-name",
          scopeSeparator: ",",
          additionalQueryStringParams: {}
        });
      }

      if(window.SwaggerTranslator) {
        window.SwaggerTranslator.translate();
      }
    },
    onFailure: function(data) {
      log("Unable to Load SwaggerUI");
    },
    docExpansion: "none",
    jsonEditor: false,
    defaultModelRendering: 'schema',
    showRequestHeaders: false
  });

  window.swaggerUi.load();

  function log() {
    if ('console' in window) {
      console.log.apply(console, arguments);
    }
  }
});
    </script>
  </head>

  <body>
    <style> 
.custom-documentation {
  display: block;
  max-width: 960px;
  margin-left: auto;
  margin-right: auto;
  line-height: 1.3;
  font-family: "Droid Sans", sans-serif;
  min-width: 760px;
}
  .custom-documentation th {
    text-align: right;
  }
    </style>
    <div class="custom-documentation">
      <h1>Open Platform</h1>
      Dette er den åbne platform, hvilket er APIet for de danske biblioteker.

      <h3>Få adgang til API'et</h3>
      Man skal være et dansk bibliotek, eller DDB, for at få API-adgang. Andre må sende forespørgslen gennem en af disse. <br>
      Forespørgslen sendes til DBCs kundeservice (https://kundeservice.dbc.dk/) med følgende informationer:

      <ul>
        <li>Projektejer kontaktperson (bibliotek, email, telefon)</li>
        <li>Teknisk kontaktperson (navn, email, telefon)</li>
        <li>Navn/beskrivelse af app/klient</li>
        <li>Eventuelt søge-profil (per default er dette det indloggede bibliotek. Alternative søgeprofiler kan være landsdækkende, såsom bibliotek.dk og biblo.dk)</li>
      </ul>

      Herefter vil biblioteket modtage et eller flere <code>CLIENT_ID</code> / <code>CLIENT_SECRET</code>, der kan bruges til at få adgang til APIet. 

      <h2>Tokens</h2>

      <p>
      Alle kald til API'et kræver en gyldig token.
      Tokens til driftmiljø'et hentes fra https://auth.dbc.dk/. Dette er en OAuth2 server, hvor der kan logges på med "password-grants".
      Ved OAuth2-login er <code>username</code>: "<em>Lånernummer</em>@<em>Biblioteks-agency</em>" og <code>password</code> er pinkode.
      </p>
      <p>
      Det er muligt at udelade lånernummer, hvorved man logger ind som en anonym bruger (OAuth2 <code>password</code> er så det samme som <code>username</code>). 
      </p>
      <p>
      Hvis man udelader lånernummer, kan man også udelade biblioteks-agency, hvorved man logger ind som anonym bruger på nationalt niveau, i stedet for på et givent bibliotek.
      </p>
      <p>

      <p>
      Det er muligt at hent et token ud fra et ClientId/ClientSecret med følgende formular:
      </p>
      <p>
      <table>
        <tr><th>ClientId:</th><td><input id=ClientId /></td><td>(påkrævet)</td></tr>
        <tr><th>ClientSecret:</th><td><input id=ClientSecret /></td><td>(påkrævet)</tr>
        <tr><th>Lånernummer:</th><td><input id=User /></td><td>(optional)</tr>
        <tr><th>PIN:</th><td><input id=PIN /></td><td>(kun påkrævet hvis lånernummer)</tr>
        <tr><th>Bibliotek-agency:</th><td><input id=Agency /></td><td>(påkrævet hvis lånernummer, ellers optional)</tr>
        <tr><th></th><td></td><td><br/><button id="fetchToken">Hent token</button></td></tr>
      </table>
      <div id=tokenDiv></div>
      </p>
      <script>

fetchToken.addEventListener('click', function () {

  if(!ClientId.value) {
    tokenDiv.innerHTML = "FEJL: Mangler ClientId";
    return;
  }
  if(!ClientSecret.value) {
    tokenDiv.innerHTML = "FEJL: Mangler ClientSecret";
    return;
  }
  if(!!User.value !== !!PIN.value) {
    tokenDiv.innerHTML = "FEJL: Både PIN og Lånernummer skal angives, hvis en af dem angives";
    return;
  }
  if(User.value && !Agency.value) {
    tokenDiv.innerHTML = "FEJL: Mangler biblioteks-agency";
    return;
  }

  var clientId = ClientId.value;
  var clientSecret = ClientSecret.value;
  var user = User.value + '@' + Agency.value;
  var passwd = PIN.value || user;
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'https://auth.dbc.dk/oauth/token');
  xhr.setRequestHeader('Authorization', 'Basic ' + btoa(clientId + ':' + clientSecret));
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.send('grant_type=password' + '&username=' + user + '&password=' + passwd);
  tokenDiv.innerHTML = "Getting token...";

  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        var result = xhr.response;
        result = JSON.parse(result).access_token;
        tokenDiv.innerHTML = "<em>Token:</em> " + String(result);
      } else {
        tokenDiv.innerHTML = "FEJL ved hent af token: " + xhr.response;
      }
    }
  };
});
      </script>

      <p>
      Eller man kan sende en request direkte til OAuth2 serveren. Herunder eksempel med curl:
      </p>
      <p><code>
        curl --user "${CLIENT_ID}:${CLIENT_SECRET}" -X POST https://auth.dbc.dk/oauth/token -d "grant_type=password&amp;username=${USERNAME}&amp;password=${PASSWORD}"
      </code></p>
      <p>
      Hvor <code>${USERNAME}</code> er <em>Lånernummer</em>@<em>Biblioteks-agency</em>, og <code>${PASSWORD}</code> er pinkode (eller det samme som <code>${USERNAME}</code> ved anonym bruger). Eksempler på username er:
      <ul>
        <li><code>12345678@710100</code> er brugeren med lånernummer 12345678, på Københavns Biblioteker, som har agency 710100</li>
        <li><code>@710100</code> er den anonyme bruger på Københavns Biblioteker</li>
        <li><code>@</code> er den anonyme bruger, der ikke er tilknyttet noget specifikt bibliotek</li>
      </ul>
      </p>


      <h3>Supplerende dokumentation</h3>

      <p>
      Kildekode, issue tracking, osv. findes på <a href="https://github.com/dbcdk/serviceprovider/">github:dbcdk/serviceprovider</a>,
      Her finder man også specifikationer, og yderligere dokumentation i <a href="https://github.com/DBCDK/serviceprovider/tree/master/doc/">doc/</a>.
      Eksempelforespørgsler, og en "getting started guide" er tilgængelig her: <a href="example.html">example.html</a> <a href="guide.html">guide.html</a>.
      </p>

      <h3>English</h3>

      <p>
      This is the Open Platform, which is the API for the danish public libraries.
      </p>

      <p>
      Danish libraries can get access directly from DBC, see the description in danish above. Others have to go through a library to get access.
      </p>
    </div>
    <div class="swagger-section">
      <div id="message-bar" class="swagger-ui-wrap" data-sw-translate>&nbsp;</div>
      <div id="swagger-ui-container" class="swagger-ui-wrap"></div>
    </div>
  </body>
</html>
